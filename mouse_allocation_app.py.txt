import streamlit as st
import pandas as pd
import numpy as np

st.set_page_config(page_title="Mouse Allocation Tool", layout="wide")
st.title("üê≠ Experimental Mouse Allocation Tool")

st.markdown("""
This tool assigns mice to experimental groups based on:
- **Sex** (M/F)
- **Genotype** (Cre+/Cre‚àí)
- **Von Frey baseline** (primary behavior to balance)
- **Batch** (aiming for all 4 groups per batch)

Each of the four groups will end with **16 mice (8M/8F)**:
1. Cre‚àí + Vehicle  
2. Cre+ + Vehicle  
3. Cre‚àí + Drug A  
4. Cre+ + Drug A
""")

uploaded_file = st.file_uploader("Upload CSV with columns: ID, Sex, Genotype, VonFrey, Grimace, Hotplate, Batch", type=["csv", "xlsx"])

if uploaded_file:
    df = pd.read_csv(uploaded_file) if uploaded_file.name.endswith("csv") else pd.read_excel(uploaded_file)
    df.columns = df.columns.str.strip().str.lower()

    # Rename columns for consistency
    df.rename(columns={
        'id': 'MouseID',
        'sex': 'Sex',
        'genotype': 'Genotype',
        'vonfrey': 'VonFrey',
        'grimace': 'Grimace',
        'hotplate': 'Hotplate',
        'batch': 'Batch'
    }, inplace=True)

    df['AssignedGroup'] = None
    df['Treatment'] = None

    group_map = {
        ("Cre-", "Vehicle"): 1,
        ("Cre+", "Vehicle"): 2,
        ("Cre-", "Drug A"): 3,
        ("Cre+", "Drug A"): 4
    }

    group_counts = {(g, s): 0 for g in range(1, 5) for s in ['M', 'F']}
    group_vonfrey = {(g, s): [] for g in range(1, 5) for s in ['M', 'F']}

    def get_eligible_groups(geno, sex):
        return [group_map[(geno, treatment)] for treatment in ["Vehicle", "Drug A"]
                if group_counts[(group_map[(geno, treatment)], sex)] < 8]

    def assign_group(row):
        geno = row['Genotype']
        sex = row['Sex']
        vf = row['VonFrey']

        eligible = get_eligible_groups(geno, sex)
        if not eligible:
            return None, None

        global_mean = df[df['Sex'] == sex]['VonFrey'].mean()

        min_dev = float('inf')
        best_group = None

        for g in eligible:
            current = group_vonfrey[(g, sex)]
            new_mean = (sum(current) + vf) / (len(current) + 1)
            deviation = abs(new_mean - global_mean)
            if deviation < min_dev:
                min_dev = deviation
                best_group = g

        treatment = "Vehicle" if best_group in [1, 2] else "Drug A"
        return best_group, treatment

    # Sort by batch to simulate batch-wise processing
    df = df.sort_values(by='Batch')

    for i, row in df.iterrows():
        group, treatment = assign_group(row)
        if group:
            df.at[i, 'AssignedGroup'] = group
            df.at[i, 'Treatment'] = treatment
            group_counts[(group, row['Sex'])] += 1
            group_vonfrey[(group, row['Sex'])].append(row['VonFrey'])

    st.success("‚úÖ Allocation completed.")

    st.subheader("üìã Assigned Table")
    st.dataframe(df)

    st.download_button("Download Assigned CSV", data=df.to_csv(index=False), file_name="assigned_mice.csv")

    st.subheader("üìä Group Summary")
    summary = df.groupby(['AssignedGroup', 'Sex']).agg(
        Count=('MouseID', 'count'),
        MeanVonFrey=('VonFrey', 'mean')
    ).reset_index()
    st.dataframe(summary)

else:
    st.info("üëÜ Upload a CSV or Excel file to begin.")
